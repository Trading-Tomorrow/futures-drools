package rules

dialect "java"

import org.futures.model.Commodity;
import org.futures.model.Volume;
import org.futures.model.Hypothesis;
import org.futures.model.PartialSignal
import java.util.HashMap
import java.util.Map;


// üî¥ Whale accumulation ‚Üí bullish
rule "Bullish - Whale accumulation detected"
when
    $commodity :Commodity()
    $v : Volume(month==$commodity.getMonth(),commodity==$commodity.getName())
    eval($v.getBuyVolume() > ($v.getBuyVolume7d() * 2) && $v.getOpenInterest()>5 && $v.getTradeSize()>=50)
then
    Map<String,Object> factors = new HashMap<>();
    factors.put("buyVolume", $v.getBuyVolume());
    factors.put("buyVolume7d", $v.getBuyVolume7d());
    factors.put("openInterest", $v.getOpenInterest());
    factors.put("tradeSize", $v.getTradeSize());
    factors.put("commodity", $commodity.getName());


    insert(new Hypothesis($v.getCommodity(),"Whale accumulation", factors, 0.9, "BUY"));
    System.out.println("üêã Whale accumulation ‚Üí bullish (period=" + $v.getMonth() +", OIŒî=" + $v.getOpenInterest() + "%, avgTrade=" + $v.getTradeSize() + ")");
end

// üî¥ Whale distribution ‚Üí bearish
rule "Bearish - Whale distribution detected"
when
    $commodity :Commodity()
    $v : Volume(month==$commodity.getMonth(),commodity==$commodity.getName())
    eval($v.getBuyVolume() > ($v.getBuyVolume7d() * 2) && $v.getOpenInterest()<-5 && $v.getTradeSize()>=50)
then
    Map<String,Object> factors = new HashMap<>();
    factors.put("buyVolume", $v.getBuyVolume());
    factors.put("buyVolume7d", $v.getBuyVolume7d());
    factors.put("openInterest", $v.getOpenInterest());
    factors.put("tradeSize", $v.getTradeSize());
    factors.put("commodity", $commodity.getName());


    insert(new Hypothesis($v.getCommodity(),"Whale distribution", factors, 0.9, "SELL"));
    System.out.println("üêã Whale distribution ‚Üí bearish (period=" + $v.getMonth() +", OIŒî=" + $v.getOpenInterest() + "%, avgTrade=" + $v.getTradeSize() + ")");
end

// ‚ö™ Neutral / no clear whale signal
rule "Neutral - Normal volume and OI"
when
    $commodity :Commodity()
    $v : Volume(month==$commodity.getMonth(),commodity==$commodity.getName())
    eval($v.getBuyVolume() <= ($v.getBuyVolume7d() * 2) && ($v.getOpenInterest()>= -5 && $v.getOpenInterest()<=5))
then
    Map<String,Object> factors = new HashMap<>();
    factors.put("buyVolume", $v.getBuyVolume());
    factors.put("buyVolume7d", $v.getBuyVolume7d());
    factors.put("openInterest", $v.getOpenInterest());
    factors.put("tradeSize", $v.getTradeSize());
    factors.put("commodity", $commodity.getName());


    insert(new Hypothesis($v.getCommodity(),"Normal volume", factors, 0.5, "HOLD"));
    System.out.println("‚ö™ No whale anomaly detected ‚Üí neutral (period=" + $v.getMonth() + ")");
end

