package rules

dialect "java"

import java.util.List;
import java.util.Map;
import java.util.HashMap;
import org.futures.model.PartialSignal;
import org.futures.model.MarketSignal;

// ðŸ“Š Aggregate PartialSignals â†’ MarketSignal
rule "Aggregate monthly market signals"
when
    // Collect all partial signals per unique month
    $signals : List() from collect(PartialSignal())
then
    // Group by month to allow multiple months in dataset
    Map<String, double[]> monthMap = new HashMap<>();

    for (Object s : $signals) {
        PartialSignal ps = (PartialSignal) s;
        String month = ps.getMonth();

        // Each double[] = { buy, sell, hold, totalWeight }
        double[] sums = monthMap.getOrDefault(month, new double[]{0, 0, 0, 0});

        switch (ps.getDecision()) {
            case "BUY":
                sums[0] += ps.getConfidence();
                break;
            case "SELL":
                sums[1] += ps.getConfidence();
                break;
            case "HOLD":
                sums[2] += ps.getConfidence();
                break;
        }
        sums[3] += ps.getConfidence(); // total weight
        monthMap.put(month, sums);
    }

    // Now compute one MarketSignal per month
    for (Map.Entry<String, double[]> entry : monthMap.entrySet()) {
        String month = entry.getKey();
        double[] s = entry.getValue();

        double buy = s[0], sell = s[1], hold = s[2];
        double total = s[3] == 0 ? 1 : s[3];

        String decision = "HOLD";
        double conf = 0.0;

        if (buy > sell * 1.1 && buy > hold) {
            decision = "BUY";
            conf = buy / total;
        } else if (sell > buy * 1.1 && sell > hold) {
            decision = "SELL";
            conf = sell / total;
        } else {
            conf = hold / total;
        }

        insert(new MarketSignal(month, decision, conf));

        System.out.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
        System.out.println("ðŸ“Š Aggregated MarketSignal for month " + month);
        System.out.println("  ðŸŸ¢ BUY:  " + String.format("%.2f", buy));
        System.out.println("  ðŸ”´ SELL: " + String.format("%.2f", sell));
        System.out.println("  âšª HOLD: " + String.format("%.2f", hold));
        System.out.println("ðŸ“ˆ FINAL DECISION â†’ " + decision + " (confidence: "
            + String.format("%.2f", conf) + ")");
        System.out.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    }
end
