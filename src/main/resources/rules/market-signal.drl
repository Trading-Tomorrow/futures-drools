package rules

dialect "java"

import java.util.List;
import java.util.Map;
import java.util.HashMap;
import org.futures.model.PartialSignal;
import org.futures.model.MarketSignal;
import org.futures.model.Hypothesis;

rule "ADD CONFIDENCES"
agenda-group "conclusions"
when
    $signals : List() from collect(Hypothesis())
    $pw : ProfileWeights( $wBuy : buyW, $wSell : sellW, $wHold : holdW )
then
    double buy=0.0;
    double sell=0.0;
    double hold=0.0;
    double total=0.0;

    for(Object s:$signals){
        Hypothesis h = (Hypothesis)s;

        switch (h.getPartialDecision()){
            case "BUY":
                buy+=h.getConfidence();
                break;
            case "SELL":
                sell+=h.getConfidence();
                break;
            case "HOLD":
                hold+=h.getConfidence();
                break;
        }
        total+=h.getConfidence();
    }

    // aplica pesos consoante o perfil
        buy  = buy  * $wBuy;
        sell = sell * $wSell;
        hold = hold * $wHold;

        total = (buy + sell + hold);

    total=total==0?1:total;

    String finalDecision = "HOLD";
    double finalConf = 0.0;

    if (buy > sell * 1.1 && buy > hold) {
        finalDecision = "BUY";
        finalConf = buy / total;
    } else if (sell > buy * 1.1 && sell > hold) {
        finalDecision = "SELL";
        finalConf = sell / total;
    } else {
        finalConf = hold / total;
    }

    insert(new MarketSignal("ALL", finalDecision, finalConf));

    System.out.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    System.out.println("ðŸ“Š Aggregated MarketSignal (all signals combined)");
    System.out.println("  ðŸŸ¢ BUY:  " + String.format("%.2f", buy));
    System.out.println("  ðŸ”´ SELL: " + String.format("%.2f", sell));
    System.out.println("  âšª HOLD: " + String.format("%.2f", hold));
    System.out.println("ðŸ“ˆ FINAL DECISION â†’ " + finalDecision + " (confidence: "
        + String.format("%.2f", finalConf) + ")");
    System.out.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
end

